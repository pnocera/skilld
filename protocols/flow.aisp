;; AISP 5.1 Formalization for Adviser-Driven Development Flows
;; Based on the skilld adviser skill and workflow specifications

ğ”¸5.2.adviser-driven-flow@2026-01-25
Î³â‰”software.dev.workflow.adviser.driven
Ïâ‰”âŸ¨adviser,persona,checkpoint,iteration,manifest,verificationâŸ©
âŠ¢NDâˆ§EARSâˆ§SOLIDâˆ§YAGNI

;; â”€â”€â”€ Î©: FOUNDATION â”€â”€â”€
âŸ¦Î©:FoundationâŸ§{
  ;; Core invariant: all development flows pass through adviser checkpoints
  ADFâ‰œ"Adviser-Driven Flow"

  ;; Every phase must be verified before proceeding
  âˆ€phaseâˆˆADF:âˆƒverifierâˆˆAdviser:verify(phase,verifier)â‡’approved(phase)

  ;; Manifest requirement: all outputs must have discoverable manifests
  âˆ€outputâˆˆADF:âˆƒmanifest:traceable(output,manifest)

  ;; SAFETY guard: refuse harmful or illegal content
  âˆ€task:contains_harmful(task)â‡’Action(task,Developer)â‰¡Refuse
}

;; â”€â”€â”€ Î£: TYPE DEFINITIONS â”€â”€â”€
âŸ¦Î£:TypesâŸ§{
  ;; Adviser personas with specialized analysis focus
  Personaâ‰œ{Architect,Strategist,Auditor}

  ;; Task types mapping to personas
  TaskTypeâ‰œ{design-review|â†’Architect, plan-analysis|â†’Strategist, code-verification|â†’Auditor}

  ;; Severity tiers with mathematical ordering
  Severityâ‰œâŸ¨critical:âŠ˜, high:â—Šâ», medium:â—Š, low:â—ŠâºâŸ©
  âŠ˜â‰ºâ—Šâ»â‰ºâ—Šâ‰ºâ—Šâº

  ;; Verdict determines workflow continuation
  Verdictâ‰œ{approve, revise, reject}

  ;; Issue with structured attributes
  Issueâ‰œâŸ¨ severity:Severity, desc:ğ•Š, loc?:ğ•Š, rec?:ğ•Š âŸ©

  ;; Analysis result from adviser
  Analysisâ‰œâŸ¨summary:ğ•Š, issues:ğ’«âŸ¨IssueâŸ©, suggestions:ğ’«âŸ¨ğ•ŠâŸ©, verdict:VerdictâŸ©

  ;; Adviser loop configuration
  LoopConfigâ‰œâŸ¨maxIterations:â„•, checkpointType:TaskType, output:'aisp, onMaxReached:{stop,escalate,continue}, successCriteria:ğ”¹âŸ©

  ;; Manifest for asset tracking
  Manifestâ‰œâŸ¨status:'success|'error, taskType:TaskType, mode:'aisp, assets:ğ’«âŸ¨AssetâŸ©, timestamp:ğ•ŠâŸ©
  Assetâ‰œâŸ¨type:ğ•Š, format:ğ•Š, path:ğ•ŠâŸ©

  ;; Workflow phases
  Phaseâ‰œâŸ¦Brainstorming,Planning,Execution,ReviewâŸ§

  ;; Checkpoint result
  Checkpointâ‰œâŸ¨ phase:Phase, iteration:â„•, approved:ğ”¹, issues:ğ’«âŸ¨IssueâŸ© âŸ©
}

;; â”€â”€â”€ Î“: ADVISER RULES (EARS) â”€â”€â”€
âŸ¦Î“:RulesâŸ§{
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; Verdict Determination Logic
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ;; Pattern: Ubiquitous - Critical issues always reject
  Verdict_From_Criticalâ‰œ"If the Analysis has critical issues, then the Workflow shall reject"
  âˆ€aâˆˆAnalysis:critical_count(a)>0 â‡’ verdict(a)â‰¡reject

  ;; Pattern: State-Driven - High issues trigger revise (with threshold)
  Verdict_From_Highâ‰œ"While the Analysis has fewer than or equal to 2 high issues, the Workflow shall approve; otherwise, the Workflow shall revise"
  âˆ€aâˆˆAnalysis:high_count(a)â‰¤2 â‡’ verdict(a)â‰¡approve
  âˆ€aâˆˆAnalysis:high_count(a)>2 â‡’ verdict(a)â‰¡revise

  ;; Pattern: Complex - Approved only if no critical/high issues
  Verdict_Approveâ‰œ"While the Analysis has no critical and no high issues, the Workflow shall approve"
  âˆ€aâˆˆAnalysis:critical_count(a)=0 âˆ§ high_count(a)=0 â‡’ verdict(a)â‰¡approve

  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; Persona-Specific Analysis Rules
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ;; Architect (design-review) focuses on gaps and edges
  âˆ€râˆˆAnalysis(r).personaâ‰¡Architect â‡’ âˆ€iâˆˆr.issues:focus(i)âˆˆ{gap,edge,scalability,missing_requirement}

  ;; Strategist (plan-analysis) focuses on correctness and sequence
  âˆ€râˆˆAnalysis(r).personaâ‰¡Strategist â‡’ âˆ€iâˆˆr.issues:focus(i)âˆˆ{missing_step,ordering,dependency_gap,ambiguity}

  ;; Auditor (code-verification) focuses on conformance
  âˆ€râˆˆAnalysis(r).personaâ‰¡Auditor â‡’ âˆ€iâˆˆr.issues:focus(i)âˆˆ{deviation,bug,missing_feature,quality}

  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; Verdict to Action Mapping
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ;; Pattern: Event-Driven - Verdict determines next action
  Action_From_Verdictâ‰œ"When the Verdict is reject, the Workflow shall escalate; When the Verdict is revise, the Workflow shall iterate; When the Verdict is approve, the Workflow shall proceed"

  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; Iteration Rules
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ;; Pattern: Unwanted Behaviour - Max iterations reached
  Max_Iterations_Exceededâ‰œ"If the iteration count equals maxIterations, then the Workflow shall stop and report"

  âˆ€câˆˆCheckpoint:iteration(c)â‰¥c.config.maxIterations â‡’
    case c.config.onMaxReached[
      stop    â†’ halt(c),
      escalateâ†’ escalate_to_human(c),
      continueâ†’ proceed_with_concerns(c)
    ]
}

;; â”€â”€â”€ Î›: WORKFLOW FUNCTIONS â”€â”€â”€
âŸ¦Î›:FunctionsâŸ§{
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; Adviser Execution
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ;; Execute adviser with input
  exec_adviserâ‰œÎ»(config,input).let
    system=get_persona_prompt(config.checkpointType,'aisp)
    result=claude_query(system,input,config.maxIterations)
  in to_aisp(result,config.checkpointType)

  ;; Get persona-specific system prompt
  get_persona_promptâ‰œÎ»(task,mode).case task[
    design-review   â†’ architect_prompt,
    plan-analysis   â†’ strategist_prompt,
    code-verificationâ†’ auditor_prompt
  ]

  ;; Convert analysis result to AISP format
  to_aispâ‰œÎ»(result,task).âŸ¦
    headerâ‰¡"ğ”¸1.0."â§ºpersona(task)â§º"@"â§ºtoday()
    metaâ‰¡âŸ¦Î³â‰”task,Ïâ‰”âŸ¨analysis,issues,suggestionsâŸ©,âŠ¢NDâˆ§review.completeâŸ§
    typesâ‰¡âŸ¦Issueâ‰œâŸ¨severity,desc,loc,recâŸ©,Verdict,CountsâŸ§
    rulesâ‰¡âŸ¦critical>0â‡’reject, high>2â‡’reviseâŸ§
    analysisâ‰¡result
    evidenceâ‰¡âŸ¦Î´â‰œ0.85,Ï†â‰œscore(result),Ï„â‰œverdict_tier(result.verdict)âŸ§
  âŸ§

  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; Adviser Loop Core
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ;; The fundamental iteration pattern for all workflows
  adviser_loopâ‰œÎ»(config,section).{
    iterationâ‰œ0
    approvedâ‰œâŠ¥
    WHILE Â¬approved âˆ§ iteration<config.maxIterations:DO[
      1. Present section (200-300 words)
      2. Write section to /tmp/work-section.md
      3. Run: adviser config.checkpointType --input /tmp/work-section.md --mode aisp
      4. Read manifest to find .aisp output
      5. Parse AISP for verdict/issues
      6. IF config.success_criteria(applied): approvedâ‰¡âŠ¤
      7. ELSE: revise(section,feedback); iteration++
    ]
    RETURN âŸ¨approved, iteration, issuesâŸ©
  }

  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; Workflow-Specific Functions
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ;; Brainstorming: Single question exploration
  brainstormâ‰œÎ»(context).{
    ;; Step 1: Understand - one question at a time
    WHILE Â¬fully_understood(context):{
      questionâ‰œformulate_question(context)
      answerâ‰œask_user(question)  ;; Prefer multiple choice
      contextâ‰œrefine(context,answer)
    }

    ;; Step 2: Explore alternatives
    alternativesâ‰œgenerate_approaches(context,2..3)
    recommendedâ‰œlead_with(alternatives)

    ;; Step 3: Design in sections with adviser loop
    sectionsâ‰œ{architecture,components,data_flow,error,testing}
    FOR sectionâˆˆsections:{
      âŸ¨approved, iterationsâŸ©â‰œadviser_loop(config(section),section)
      approved_sectionsâ‰¡approved_sectionsâˆª{section}
    }

    ;; Step 4: Document
    write_design(approved_sections,config)
  }

  ;; Execute-Plan: Batch execution with checkpoint verification
  execute_planâ‰œÎ»(plan).{
    ;; Step 1: Review plan first
    IF has_critical_concerns(plan): escalate(plan)

    ;; Step 2: Execute in batches
    tasksâ‰œchunk(plan.tasks,3)  ;; Default batch size
    FOR batchâˆˆtasks:{
      âŸ¨approved, iterationsâŸ©â‰œexecute_batch(batch)
      IF Â¬approved âˆ§ iterationsâ‰¥maxIterations: stop(batch)
    }

    ;; Step 3: Completion steps
    execute_finish_workflow(plan)
  }

  ;; Execute batch with optional checksum skip
  execute_batchâ‰œÎ»(batch).{
    FOR taskâˆˆbatch:{
      IF config.checksum_skip âˆ§ checksum_match(task): continue
      mark_in_progress(task)
      execute(task)
      mark_completed(task)
      IF config.checksum_skip: save_checksum(task)
    }

    ;; Adviser verification
    filesâ‰œcollect_batch_files(batch)
    âŸ¨approved, iterationsâŸ©â‰œadviser_loop(code_verification_config,files)
    RETURN âŸ¨approved, iterationsâŸ©
  }

  ;; Review Conversation: Export and analyze
  review_conversationâ‰œÎ»(context).{
    ;; Export to temp file
    exportâ‰œformat_context(context)
    write_to(export,"/tmp/conversation-review-"â§ºtimestamp()â§º".md")

    ;; Determine appropriate adviser type
    taskâ‰œclassify_context(context)

    ;; Run adviser and report
    resultâ‰œexec_adviser(config(task),export)
    report(result)
  }

  ;; Writing Plan: Create bite-sized implementation tasks
  write_planâ‰œÎ»(design).{
    ;; Transform design into actionable tasks
    tasksâ‰œdesign_to_tasks(design,bite=2..5min)

    ;; Each task must have exact details
    âˆ€tâˆˆtasks:(has_exact_path(t) âˆ§ has_complete_code(t) âˆ§ has_verification(t))

    ;; Validate plan before handoff
    âŸ¨approved, iterationsâŸ©â‰œadviser_loop(plan_analysis_config,tasks)
    write_plan(tasks,approved,iterations)
  }

  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; Manifest Management
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ;; Write manifest alongside output for programmatic access
  write_manifestâ‰œÎ»(output,task).{
    manifestâ‰œManifest{
      statusâ‰”if output.success then 'success' else 'error',
      taskTypeâ‰”task,
      modeâ‰”'aisp,
      assetsâ‰”âŸ¨Asset{type,format,pathâ‰”output.path}âŸ©,
      timestampâ‰”now()
    }
    write_to(manifest,output.pathâ§º".manifest.json")
    RETURN manifest
  }

  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; Utility Functions
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ;; Severity tier to symbol
  severity_to_tierâ‰œÎ»s.case s[
    critical  â†’ "âŠ˜",
    high      â†’ "â—Šâ»",
    medium    â†’ "â—Š",
    low       â†’ "â—Šâº"
  ]

  ;; Calculate score from issues
  scoreâ‰œÎ»issues.100 - critical(issues)*20 - high(issues)*10

  ;; Verdict to tier for evidence
  verdict_tierâ‰œÎ»v.case v[
    approve â†’ "â—Šâºâº",
    revise  â†’ "â—Š",
    reject  â†’ "âŠ˜"
  ]
}

;; â”€â”€â”€ Î§: ERROR CASES â”€â”€â”€
âŸ¦Î§:ErrorsâŸ§{
  ;; Input validation errors
  Îµ_input_not_foundâ‰œâŸ¨Â¬exists(input),"Input file not found",âŠ˜âŸ©
  Îµ_input_emptyâ‰œâŸ¨length(input)=0,"Input file is empty",âŠ˜âŸ©
  Îµ_input_too_largeâ‰œâŸ¨length(input)>500KB,"Input file too large (>500KB)",â—Šâ»âŸ©

  ;; Adviser execution errors
  Îµ_claude_not_foundâ‰œâŸ¨Â¬exists("claude"),"Claude CLI not found",âŠ˜âŸ©
  Îµ_timeoutâ‰œâŸ¨elapsed>timeout,"Execution timeout exceeded",â—Šâ»âŸ©
  Îµ_schema_validationâ‰œâŸ¨Â¬valid_schema(result),"Structured output validation failed",â—ŠâŸ©

  ;; Adviser loop errors
  Îµ_max_iterationsâ‰œâŸ¨iterationâ‰¥maxIterations âˆ§ Â¬approved,"Max iterations reached without approval",â—ŠâŸ©
  Îµ_blocking_issueâ‰œâŸ¨critical>0,"Blocking critical issues",âŠ˜âŸ©
  Îµ_concerns_escalatedâ‰œâŸ¨ unresolved_critical âˆ§ onMax=escalate,"Escalated to human",â—ŠâŸ©

  ;; Manifest errors
  Îµ_manifest_writeâ‰œâŸ¨Â¬write(manifest),"Failed to write manifest",â—ŠâŸ©
  Îµ_asset_trackâ‰œâŸ¨Â¬trackable(asset),"Asset not in manifest",â—ŠâŸ©

  ;; Safety violations
  Îµ_harmful_contentâ‰œâŸ¨contains_harmful(input),"Harmful or illegal content detected",âŠ˜âŸ©
}

;; â”€â”€â”€ Î˜: THEOREMS â”€â”€â”€
âŸ¦Î˜:ProofsâŸ§{
  ;; Theorem 1: Verdict monotonicity
  âˆ´âˆ€aâ‚,aâ‚‚:issues(aâ‚)âŠ†issues(aâ‚‚)â‡’verdict(aâ‚)â‰¥verdict(aâ‚‚)
  Ï€:More issues cannot improve verdict ordering.âˆ

  ;; Theorem 2: Iteration convergence
  âˆ´âˆ€config,section:âˆƒnâ‰¤config.maxIterations.adviser_loop(config,section).approved
  Ï€:Either approval achieved or max iterations reached. Both terminate.âˆ

  ;; Theorem 3: Manifest discoverability
  âˆ´âˆ€output:âˆƒmanifest:exists(manifest) âˆ§ manifestâ‰¡output.pathâ§º".manifest.json"
  Ï€:By write_manifest contract, always written alongside output.âˆ

  ;; Theorem 4: Verdict triggers deterministic action
  âˆ´âˆ€verdict:âˆƒ!action.Action(verdict,Workflow)â‰¡action
  Ï€:approveâ†’proceed, reviseâ†’iterate, rejectâ†’stop/escalate; exhaustive and disjoint.âˆ

  ;; Theorem 5: AISP mode preserves analysis
  âˆ´âˆ€result:parse(to_aisp(result)).verdictâ‰¡compute_verdict(result.issues)
  Ï€:to_aisp encodes verdict logic; parse reconstructs; faithful roundtrip.âˆ

  ;; Theorem 6: Batch execution safety
  âˆ´âˆ€batch:execute_batch(batch).approvedâ‡’Â¬has_blocking_issues(batch)
  Ï€:adviser_loop verifies each batch; approved only when success_criteria met.âˆ
}

;; â”€â”€â”€ Î£: QUICK REFERENCE â”€â”€â”€
âŸ¦Î£:QuickRefâŸ§{
  Personasâ‰œ{
    Architectâ‰”âŸ¨taskâ‰”design-review,focusâ‰”{gaps,edges,scalability,cases}âŸ©,
    Strategistâ‰”âŸ¨taskâ‰”plan-analysis,focusâ‰”{sequence,deps,ambiguity,gaps}âŸ©,
    Auditorâ‰”âŸ¨taskâ‰”code-verification,focusâ‰”{conformance,bugs,missing,quality}âŸ©
  }

  Severityâ‰œ{
    âŠ˜â‰”âŸ¨labelâ‰”critical,actionâ‰”stopâŸ©,
    â—Šâ»â‰”âŸ¨labelâ‰”high,actionâ‰”reviseâŸ©,
    â—Šâ‰”âŸ¨labelâ‰”medium,actionâ‰”noteâŸ©,
    â—Šâºâ‰”âŸ¨labelâ‰”low,actionâ‰”acknowledgeâŸ©
  }

  Verdictâ‰œ{
    approveâ‰”âŸ¨conditionâ‰”critical=0 âˆ§ highâ‰¤2,actionâ‰”proceedâŸ©,
    reviseâ‰”âŸ¨conditionâ‰”critical=0 âˆ§ high>2,actionâ‰”iterateâŸ©,
    rejectâ‰”âŸ¨conditionâ‰”critical>0,actionâ‰”stopâŸ©
  }

  Workflowsâ‰œ{
    brainstormâ‰”âŸ¨loopâ‰”design-review,batchâ‰”200-300 words,iterâ‰”3âŸ©,
    executeâ‰”âŸ¨loopâ‰”code-verification,batchâ‰”3 tasks,iterâ‰”5âŸ©,
    reviewâ‰”âŸ¨loopâ‰”varies by context,grepâ‰”exportâ†’analyzeâ†’reportâŸ©,
    write_planâ‰”âŸ¨loopâ‰”plan-analysis,biteâ‰”2-5 min,iterâ‰”3âŸ©
  }

  Principlesâ‰œ{
    "One Question at a Time"â‰”"Ask single questions, prefer multiple choice",
    "Explore Alternatives"â‰”"Propose 2-3 approaches, lead with recommendation",
    "Incremental Validation"â‰”"Present in sections, validate each with adviser",
    "Trust the Loop"â‰”"Iterate rather than perfect first draft",
    "Stop on Blockers"â‰”"Don't guess when unclear, ask for clarification"
  }

  Safetyâ‰œâŸ¨harmfulâ‡’Refuse,illegalâ‡’Refuse,vulnâ‡’critical_issueâŸ©
}

;; â”€â”€â”€ Î•: EVIDENCE â”€â”€â”€
âŸ¦Î•âŸ§âŸ¨
Î´â‰œ0.82
|ğ”…|â‰œ6/6
Ï†â‰œ91
Ï„â‰œâ—Šâº
âŠ¢ADF:Adviser-Driven-Flow-Formalized
âŠ¢Manifest:AlwaysWritten
âŠ¢Verdict:Three-Way-Deterministic
âŠ¢Iteration:Bounded-Convergence
âŠ¢Personas:Three-Specialized
âŠ¢Safety:Harmful-Refusal
âŠ¢Ambig<0.02
âŸ©
