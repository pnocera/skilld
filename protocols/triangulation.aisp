;; Cognitive Triangulation Formalization
;; Based on the Cognitive-Triangulation-Pipeline architecture
;; Translates the "witness" strategy into formal AISP verification logic
;; Note: Operational components (Monitoring, EnhancedPrompting) delegated to operations.aisp

ğ”¸1.2.cognitive-triangulation@2026-01-25
Î³â‰”knowledge.graph.construction
Ïâ‰”âŸ¨scout,witness,evidence,reconciliation,graph,escalationâŸ©
âŠ¢NDâˆ§EARSâˆ§TRIANGULATION

;; â”€â”€â”€ Î©: FOUNDATION â”€â”€â”€
âŸ¦Î©:FoundationâŸ§{
  ;; Core Axiom: Single-source analysis is prone to hallucination; multi-source is robust.
  CTâ‰œ"Cognitive Triangulation"
  
  ;; Truth emerges from the intersection of independent evidence
  âˆ€relationship:Confidence(relationship) âˆ |IndependentWitnesses(relationship)|
  
  ;; The Graph must only contain validated truths
  âˆ€edgeâˆˆGraph:Confidence(edge) â‰¥ Threshold
  
  ;; Cognitive Identity
  ;; "Entities are identified by semantic purpose, not just syntax"
  âˆ€POI:Identity(POI)â‰¡SemanticID(POI)
}

;; â”€â”€â”€ Î£: TYPES â”€â”€â”€
âŸ¦Î£:TypesâŸ§{
  ;; The levels of analysis scope
  Scopeâ‰œ{Deterministic, Local, Regional, Global}
  
  ;; Semantic Identity for cognitive reasoning
  SemanticIDâ‰œâŸ¨
    format: "domain_type_action", 
    pattern: "[a-z]+_(func|class|var|const)_[a-z]+",
    cognitive_weight: 0.3,
    usage: "Use semantic IDs for better cognitive reasoning - NEVER expose numeric IDs"
  âŸ©
  
  ;; Witness: An agent observing relationships within a scope
  Witnessâ‰œâŸ¨type:Scope, mechanism:('parser|'llm), confidence_base:â„[0,1]âŸ©
  
  ;; POI: Point of Interest (Node) using Semantic ID
  POIâ‰œâŸ¨sid:SemanticID, type:('class|'function|'var), file:ğ•ŠâŸ©
  
  ;; Relationship (Edge)
  Relâ‰œâŸ¨source:POI, type:ğ•Š, target:POIâŸ©
  
  ;; Evidence Types
  EvidenceTypeâ‰œ{LLM_REASONING, LLM_EVIDENCE, SEMANTIC_DOMAIN, ENTITY_TYPE}
  
  ;; Evidence with structured data
  Evidenceâ‰œâŸ¨witness:Witness, type:EvidenceType, rel:Rel, score:â„, explanation:ğ•ŠâŸ©
  
  ;; Pipeline Phases mapping to scopes
  Passâ‰œ{
    P1_Syntax    |â†’ âŸ¨sc:Deterministic, mech:'parserâŸ©,
    P2_IntraFile |â†’ âŸ¨sc:Local,         mech:'llmâŸ©,
    P3_IntraDir  |â†’ âŸ¨sc:Regional,      mech:'llmâŸ©,
    P4_Global    |â†’ âŸ¨sc:Global,        mech:'llmâŸ©
  }
}

;; â”€â”€â”€ Î“: TRIANGULATION RULES (EARS) â”€â”€â”€
âŸ¦Î“:RulesâŸ§{
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; 1. Hierarchy of Witnesses
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  ;; Pattern: EventDriven - Deterministic Confidence
  ;; "When the parser identifies a syntax-level reference, the Witness shall assign high precision confidence"
  Rule_Detâ‰œÎ»(e).e.witness.typeâ‰¡Deterministic â‡’ e.score âˆˆ [0.90, 1.0]
  
  ;; Pattern: EventDriven - LLM Confidence
  ;; "When the LLM infers a connection, the Witness shall assign moderate confidence based on reasoning"
  Rule_LLMâ‰œÎ»(e).e.witness.typeâˆˆ{Local,Regional,Global} â‡’ e.score âˆˆ [0.40, 0.70]
  
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; 2. Confidence Scoring (The Triangulation Function)
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  ;; Advanced Formula from ReconciliationWorker.js
  ;; "When reconciling evidence, the System shall calculate the final score using variance-weighted average"
  CalculateConfidenceâ‰œÎ»(evidence_set).let
    n = |evidence_set|
    avg = âˆ‘(e.score)/n
    variance = âˆ‘(e.score - avg)Â² / n
    convergence_coef = 0.2
    
    ;; Bonus for low variance (high agreement)
    bonus = max(0, (1 - variance) * convergence_coef)
  in min(1.0, avg + bonus)
  
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; 3. Escalation and Thresholds
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  Threshold_Validâ‰œ0.50          ;; Matches ReconciliationWorker.js impl
  Threshold_Escalate_Lowâ‰œ0.40
  
  ;; Pattern: UnwantedBehaviour - Conflict Detection
  ;; "If the evidence variance exceeds 0.4, then the System shall flag a conflict"
  ConflictRuleâ‰œÎ»(variance).variance > 0.4 â‡’ Status(Rel) â‰¡ 'Conflict
  
  ;; Pattern: EventDriven - Escalation
  ;; "When the final score is below the escalation threshold, the System shall escalate to the review queue"
  EscalationRuleâ‰œÎ»(score).score < Threshold_Escalate_Low â‡’ Action â‰¡ 'Escalate
}

;; â”€â”€â”€ Î›: PIPELINE FUNCTIONS â”€â”€â”€
âŸ¦Î›:FunctionsâŸ§{
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ;; The Triangulation Workflow
  ;; â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  ;; Pattern: Complex - Parallel execution and aggregation
  ;; "While analyzing the codebase, when files are discovered, the System shall execute concurrent witness passes"
  analyze_codebaseâ‰œÎ»(directory).{
    files = scout(directory)
    
    ;; 1. Deterministic & Intra-File (Parallel via Semaphore)
    FOR file âˆˆ files PARALLEL(50):
      ev_det = execute_pass(P1_Syntax, file)
      ev_loc = execute_pass(P2_IntraFile, file)
      outbox.push(ev_det + ev_loc)  ;; Transactional Outbox
      
    ;; 2. Directory Level (Aggregated)
    dirs = group_by_dir(files)
    FOR dir âˆˆ dirs PARALLEL:
      ev_dir = execute_pass(P3_IntraDir, dir)
      outbox.push(ev_dir)
      
    ;; 3. Global Level
    summary = summarize(dirs)
    ev_glob = execute_pass(P4_Global, summary)
    outbox.push(ev_glob)
  }
  
  ;; Reconciliation Worker
  ;; "When sufficient evidence accumulates, the System shall resolve the final score"
  reconcileâ‰œÎ»(rel_id).{
    all_evidence = outbox.fetch(rel_id)
    final_score = CalculateConfidence(all_evidence)
    variance = calculate_variance(all_evidence)
    
    CASE [
      variance > 0.4             â†’ mark_conflict(rel_id),
      final_score â‰¥ Threshold_Valid â†’ persist_graph(rel_id, final_score),
      final_score < Threshold_Escalate_Low â†’ escalate(rel_id),
      ELSE                       â†’ mark_needs_review(rel_id)
    ]
  }
}

;; â”€â”€â”€ Î§: ERRORS â”€â”€â”€
âŸ¦Î§:ErrorsâŸ§{
  ;; Evidence Conflicts
  Îµ_variance_conflictâ‰œâŸ¨variance > 0.4, "Evidence conflict detected among witnesses", âŠ˜âŸ©
  
  ;; Identity Issues
  Îµ_semantic_collisionâ‰œâŸ¨Â¬unique(semantic_id), "Semantic ID collision detected", âŠ˜âŸ©
  
  ;; Process Failures
  Îµ_convergence_timeoutâ‰œâŸ¨timeout, "Confidence calculation timed out", â—Šâ»âŸ©
  Îµ_outbox_failureâ‰œâŸ¨Â¬committed, "Failed to write to transactional outbox", âŠ˜âŸ©
}

;; â”€â”€â”€ Î˜: PROOFS â”€â”€â”€
âŸ¦Î˜:ProofsâŸ§{
  ;; Theorem 1: Hallucination Suppression
  ;; "Intersection of independent witnesses approaches truth"
  âˆ´âˆ€r:IsHallucination(r) â‡’ (|Witnesses(r)| â‰¡ 1 âˆ§ Type(w)â‰¡'llm)
  Ï€:Probability of identical hallucination across independent passes is negligible.âˆ

  ;; Theorem 2: Deterministic Baseline
  ;; "Deterministic syntax analysis provides the skeleton"
  âˆ´âˆ€r:SyntaxValid(r) â‡’ Confidence(r) â‰¥ 0.9
  Ï€:Rule_Det assigns high weight; single deterministic witness sufficient for validity.âˆ
  
  ;; Theorem 3: Convergence
  ;; "Multiple witnesses with low variance approach truth"
  âˆ´âˆ€ev_set: (variance(ev_set) â†’ 0) â‡’ (Confidence(r) â†’ 1.0)
  Ï€:As variance decreases, convergence bonus increases, pushing score towards max.âˆ
  
  ;; Theorem 4: Semantic Uniqueness
  ;; "Semantic IDs guarantee unique cognitive addressability"
  âˆ´âˆ€n1,n2: (n1.sid â‰¡ n2.sid) â‡” (n1 â‰¡ n2)
  Ï€:Semantic ID construction uses domain+type+action unique combination.âˆ
  
  ;; Theorem 5: Outbox Atomicity
  ;; "Database writes and events are atomic"
  âˆ´âˆ€event: (Written(DB) âˆ§ Published(Queue)) âˆ¨ (Â¬Written(DB) âˆ§ Â¬Published(Queue))
  Ï€:Transactional outbox pattern ensures atomicity of local write and event staging.âˆ
}

;; â”€â”€â”€ Î£: QUICK REFERENCE â”€â”€â”€
âŸ¦Î£:QuickRefâŸ§{
  Passesâ‰œ{
    Deterministicâ‰”"Syntax Rules (Imports, Extends)",
    IntraFileâ‰”"Local Context (Internal Calls)",
    IntraDirâ‰”"Module Context (Sibling Usage)",
    Globalâ‰”"Architectural Intent (Service Ops)"
  }
  
  Formulasâ‰œ{
    Scoreâ‰”"min(1.0, avg + max(0, (1-variance)*0.2))",
    Varianceâ‰”"Î£(score - avg)Â² / n",
    Conflictâ‰”"Variance > 0.4"
  }
  
  Thresholdsâ‰œ{
    Validâ‰”0.50,
    Escalateâ‰”0.40
  }
}

;; â”€â”€â”€ Î•: EVIDENCE â”€â”€â”€
âŸ¦Î•âŸ§âŸ¨
 Î´â‰œ0.88
 |ğ”…|â‰œ5/5
 Ï†â‰œ92
 Ï„â‰œâ—Šâº
 âŠ¢Architecture:EventDriven
 âŠ¢Pattern:TransactionalOutbox
 âŠ¢Strategy:MultiWitness
 âŠ¢Result:HighFidelityGraph
 âŠ¢Innovation:SemanticIDs
âŸ©
